// Generated by CoffeeScript 1.10.0
(function() {
  var $, UserStringGetter,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $ = require('jqueryify');

  module.exports = UserStringGetter = (function() {
    UserStringGetter.prototype.ANONYMOUS = "(anonymous)";

    UserStringGetter.prototype.currentUserID = UserStringGetter.ANONYMOUS;

    UserStringGetter.prototype.zooniverseCurrentUserChecker = null;

    UserStringGetter.prototype.returnAnonymous = function() {
      return this.ANONYMOUS;
    };

    function UserStringGetter(zooniverseCurrentUserCheckerFunction) {
      this.zooniverseCurrentUserCheckerFunction = zooniverseCurrentUserCheckerFunction;
      this.getUserIDorIPAddress = bind(this.getUserIDorIPAddress, this);
      this.checkZooniverseCurrentUser = bind(this.checkZooniverseCurrentUser, this);
      this.returnAnonymous = bind(this.returnAnonymous, this);
      console.log("in constructor of zoo user string getter");
      if (this.zooniverseCurrentUserCheckerFunction instanceof Function) {
        this.zooniverseCurrentUserChecker = this.zooniverseCurrentUserCheckerFunction;
      } else {
        this.zooniverseCurrentUserChecker = this.returnAnonymous;
      }
    }

    UserStringGetter.prototype.checkZooniverseCurrentUser = function() {
      var newValueForCurrentUser;
      if (this.zooniverseCurrentUserChecker !== null && this.zooniverseCurrentUserChecker instanceof Function && this.zooniverseCurrentUserChecker() !== null) {
        newValueForCurrentUser = this.zooniverseCurrentUserChecker();
        if (newValueForCurrentUser !== null) {
          console.log("checkZoo method: The callback user getter function returned " + newValueForCurrentUser);
        } else {
          console.log("checkZoo method: The callback user getter function returned null.");
        }
        if (!!newValueForCurrentUser) {
          console.log("checkZoo method setting current UserID in getter to that value.");
          this.currentUserID = this.zooniverseCurrentUserChecker();
        } else {
          console.log("checkZoo method setting current UserID in getter to " + this.ANONYMOUS + " (1).");
          this.currentUserID = this.ANONYMOUS;
        }
      } else {
        console.log("checkZoo method setting current UserID in getter to " + this.ANONYMOUS + " (2).");
        this.currentUserID = this.ANONYMOUS;
      }
      return this.currentUserID;
    };

    UserStringGetter.prototype.getClientOrigin = function() {
      var eventualIP;
      eventualIP = new $.Deferred;
      $.get('https://api.ipify.org').then((function(_this) {
        return function(ip) {
          return eventualIP.resolve({
            ip: ip,
            address: ip
          });
        };
      })(this)).fail((function(_this) {
        return function() {
          return eventualIP.resolve({
            ip: '?.?.?.?',
            address: _this.ANONYMOUS
          });
        };
      })(this));
      return eventualIP.promise();
    };

    UserStringGetter.prototype.getNiceOriginString = function(data) {
      if ((data.ip != null) && (data.address != null)) {
        if (data.ip === '?.?.?.?') {
          return this.ANONYMOUS;
        } else if (data.ip === data.address) {
          return "(" + data.ip + ")";
        } else {
          return "(" + data.address + " [" + data.ip + "])";
        }
      } else {
        return this.ANONYMOUS;
      }
    };

    UserStringGetter.prototype.getUserIDorIPAddress = function() {
      var checkUserNow, eventualUserID;
      eventualUserID = new $.Deferred;
      if (this.zooniverseCurrentUserChecker !== null) {
        checkUserNow = this.checkZooniverseCurrentUser();
        if (checkUserNow && this.currentUserID !== checkUserNow) {
          eventualUserID.resolve(this.currentUserID);
        } else if ((this.currentUserID != null) && this.currentUserID !== this.ANONYMOUS) {
          eventualUserID.resolve(this.currentUserID);
        } else {
          this.getClientOrigin().then((function(_this) {
            return function(data) {
              if (data != null) {
                console.log("service returned: ");
                console.log(data);
                _this.currentUserID = _this.getNiceOriginString(data);
                return console.log("getUserID method set currentUserID to " + _this.currentUserID);
              }
            };
          })(this)).always((function(_this) {
            return function() {
              return eventualUserID.resolve(_this.currentUserID);
            };
          })(this));
        }
      } else {
        eventualUserID.resolve(this.ANONYMOUS);
      }
      return eventualUserID.promise();
    };

    return UserStringGetter;

  })();

}).call(this);
